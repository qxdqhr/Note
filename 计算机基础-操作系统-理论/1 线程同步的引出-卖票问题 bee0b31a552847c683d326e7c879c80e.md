# 1.线程同步的引出-卖票问题

# 线程同步问题的引出:卖票问题(线程并发问题)

## 问题描述:100张票,分10个窗口卖票

## 解决思路:

1. 100张票，10窗口在卖:
    - **需要十根线程同时操作同一资源**;
2. 创建一个窗体程序,并且窗口中应带有:
    - listbox控件:用于显示对应买票情况;
    - 按钮控件:用于点击后开始卖票;

## 具体完成代码过程:

### 准备工作:

1. 创建MFC应用程序(基于对话框,使用Unicode库)
2. 删除窗口控件中的所有控件
3. 添加ListBox,Button控件
    1. 右击控件listbox对其添加变量(control类型);
    2. 去掉ListBox控件中的排序属性; ### 创建线程:
4. 类成员中添加一个句柄数组
    1. 能够存储并控制所有的被创建出的线程;
    2. 数组中定义的线程数可以使用宏来表示;
5. 双击按钮,进入按钮事件函数:
6. 创建10条线程(使用for循环)
7. 用线程句柄数组中的每一个成员盛放创建好的线程
    
    ```cpp
    _beginthreadex(
              0,              //安全属性
              0,              //线程栈大小
              &ThreadProc,    //线程函数地址
              this,           //线程函数中的参数,这里传入this指针
              0,              //创建标志
              0,              //线程ID
              );
    ```
    
    - 注意:
        - 线程工作函数被定义为静态函数
        - 当任意1条线程在调用线程函数时,均在线程自身的线程栈中,不会导致线程非法操作内存;
8. 确定线程工作函数的声明与定义:
    - 静态函数:声明时包含静态static,定义时将static去掉
    - 返回值为unsigned _stdcall
    - 参数为void* Ipvoid

### 线程函数中的工作:

1. 将参数Ipvoid泛型指针强制类型转化为本类类型 1. 线程函数中通过指针调用本类成员
2. 定义一个类成员变量用于记录票数(Long类型)
    1. 在构造函数中将其初始化;
3. 在线程函数中使此变量的值减少1,表示卖出1张票;
4. 卖票时,须保证票数大于0;判断当前的票为0时,break,跳出循环; 

### 线程工作的结束:

1. 定义类成员 bool类型 bflag
    1. 用于判断线程何时结束,在构造函数中将其初始化为true;
2. 点击窗口的叉键退出时,需要销毁正在运行的所有线程;在窗口属性中设定Close消息函数,依次销毁每一个线程;
3. 首先将类成员的判断变量置为flase,并开始20次For循环(与创建出的线程数量相同)
4. 循环中判断线程是否有信号（如果未正常退出则会超时）;
    1. 若等待超时,强行终止进程,终止进程后，关闭窗口;
    2. 非正常退出线程销毁强杀线程 

### 显示执行结果:

1. 在类成员中添加一个CString变量,用于结果显示;
2. 使用CString对象调用Format函数,以格式化输出一段文字(用法类似printf函数)
3. 在之前添加好的ListBox控件变量处调用Addstring函数,将此CString对象在ListBox上显示;

## 出现问题:(线程并发问题)

- 查看运行结果发现有**多个线程**在**卖同一张票**,出现了线程并发导致的问题;
    - 多个线程不应能对同一变量进行修改;需要使用方法线程同步方法解决;
    - 产生原因:
        - 两条线程同时对同一变量进行操作
            - 并发操作,此变量的操作仅进行了一次
            - 并行操作,此变量的操作正常运行,进行了两次

### 注意:

- 此处线程同步指的是使线程能够同步的进行工作;
    - 线程同步是用于解决线程并发问题的一种方法;
    - 多个线程交替的使用同一个资源(变量,代码段等);

# 基于用户空间的两种线程同步方式:

原子访问:同一时刻只允许一个线程访问资源

关键段:

# 基于内核空间的线程同步的几种方式：

互斥量;信号量;事件;