# 开机进入操作系统的流程(x86 结构)

# CS:IP(当前要读取的指令地址)

- CPU 中存在两个寄存器:它们共同指示了**CPU当前要读取指令的地址**
    - CS 寄存器:代码段地址寄存器
    - IP 寄存器:指令地址寄存器
    - 在8086机中，任意时刻，每次,CPU将 **CS:IP指向的内容** 作为**指令**来执行。

# CPU 的模式(确定一个 CPU 的寻址方式)

- 实模式
    - CS:IP=CS<<4+IP
    - 指令地址的计算方式:代码段基地址<<4+代码段内偏移
        - 代码段基地址  存储在  代码段地址 (CS) 寄存器中
        - 代码段内偏移  存储在 指令地址  (IP)  寄存器中
- 保护模式

# 流程:

## 计算机通电后:先运行 BIOS 段代码

[BIOS 段代码](%E5%BC%80%E6%9C%BA%E8%BF%9B%E5%85%A5%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%B5%81%E7%A8%8B(x86%20%E7%BB%93%E6%9E%84)%20bc1b681e7da94955a54f10ac0cf20172/BIOS%20%E6%AE%B5%E4%BB%A3%E7%A0%81%20e821c2ebe76c4c2f8e3fa8b857a648a1.md)

1. CPU 处于实模式,并开始不断地进行 **取址,执行** 两个动作
2. CPU 中的 CS 寄存器 中存储 0xFFFF 值 (电脑出厂设定)
3. CPU 中的 IP 寄存器 中存储 0x0000 值 (电脑出厂设定)
4. CPU 通过 CS:IP 计算出下一条需要执行的指令地址: (CS:IP=CS<<4+IP)
    1. 得到 0xFFFF0
    2.  0xFFFF0 这段地址指向的是 ROM 中的 BIOS (Basic Input Output System) 映射区
        1. ROM 是一块只读内存,在电脑出厂时设定,是电脑在初始状态下唯一有代码的地方

## 执行 BIOS 段代码:加载操作系统的引导程序到内存中

1. 进入 BIOS 映射区 后,主要分为以下几点工作:
    1.  检查 RAM 键盘 显示器 软硬磁盘 等硬件设备
    2. 从内存的 地址 0 开始,设置 BIOS的中断向量表
    3. 加载操作系统的引导程序

### 加载操作系统的引导程序(0x7c00)

1. 操作系统不会一次性全部被加载到内存中,启动时仅加载操作系统的引导程序
2. 操作系统的引导程序都被放置在一个固定的地址中;
    1. 这个地址由 BIOS 规定 
        1. 因为 不同的操作系统加载方式不同
        2. BIOS 只能读取对应的 引导程序,从而加载对应系统
    2. 这个固定的地址指向 **磁盘的 0 磁道0 扇区 ,值为** 0x7c00
        
        [关于地址:0x7C00的来源](%E5%BC%80%E6%9C%BA%E8%BF%9B%E5%85%A5%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%B5%81%E7%A8%8B(x86%20%E7%BB%93%E6%9E%84)%20bc1b681e7da94955a54f10ac0cf20172/%E5%85%B3%E4%BA%8E%E5%9C%B0%E5%9D%80%200x7C00%E7%9A%84%E6%9D%A5%E6%BA%90%2097154bef10784b6da1d04955b8ca11e3.md)
        
3. 为了使 CPU 能够访问到操作系统的引导程序,重新设置 CS:IP = 0x7c00
    1. 此时 CPU 仍然是实模式(CS:IP=CS<<4+IP),可以推知:
        1. CS 寄存器中的值=0x07c0
        2. IP 寄存器中的值=0x0000
4. CPU将 **磁盘的 0 磁道0 扇区** 的代码 ****读入内存中地址 0x7c00 中
    1. 磁盘的 0 磁道0 扇区 存储的是 **操作系统的引导程序(512 字节)**
    2. 磁盘的 0 磁道0 扇区 也被叫做 **引导扇区**
    3. 操作系统的引导程序 是 **操作系统中的第一段代码**
        1. 这段代码也被叫做**主引导记录,**地址=0x7c00,大小=512字节
5. 成功进入操作系统的引导程序

## 引导程序代码:bootsect.s(汇编代码)

- 使用汇编原因:能够具体指定某一段内存地址进行操作

- 读入 setup,再读入其他代码

## setup

## CPU进入保护模式(32 位模式)

- 扩大寻址范围
- 实模式是 16 位模式
- 改变了寻址方式(通过切换电路):cr0寄存器

jump 0,8

boot→setup→head→main→mem_init()

将磁盘中的操作系统读入内存

读入内存后CPU才能继续进行取址执行操作系统程序

初始化操作系统的各项参数